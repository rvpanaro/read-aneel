---
title: "read_aneel"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path = "img/", message = FALSE, 
                      warning = FALSE)
options(scipen = 9999, digits = 4, OutDec = ",")
```

# Análise exploratória da BD do relatório de indicadores de 
sustentatibilidade econômico-financeiros - ANEEL 

Dada a necessidade de sistematização do monitoramento econômico-financeiro, a 
ANEEL compila uma base de dados com variáveis financeiras e operacionais das 
empresas distribuidoras de energia elétrica. As bases estão presentes em cinco
arquivos .xlsx e apresentam dados anuais para cada empresa até 2016 e trimestrais
desde então. Embora a base de dados tenha um grande número de variáveis disponíveis, os principais
indicadores foram selecionados na 5ª Edição do Relatório de Indicadores de Sustentabilidade Econômico-Financeira das Distribuidoras (pg 28):

![Figura 1 : Indicadores Selecionados.](./img/indicadores.png)

## Análise de consistência 

O banco de dados ou base de dados (BD) é uma coleção organizada de dados que se relacionam de forma a criar alguma informação, capaz de direcionar pesquisas, estudos e tomadas de decisão. O modelo (plano) de BD adotado pela ANEEL consiste de matrizes bidimensionais que são a base para as planilhas eletrônicas, compostas por células de caracteres, inteiros ou números reais. 

A verificação de consistência é uma avaliação realizada para indicar se a BD apresenta algum conflito interno ou incoerência. Nesse sentido, esta seção tem como objetivo averiguar a qualidade dos dados e relatar problemas ou erros no conjunto de dados fornecidas pela ANEEL.

### Repetição de Atributos (Colunas)

A repetição na nomenclatura dos atributos foi um grave problema encontrado nas cinco bases de dados dos Relatórios de Sustentabilidade, no arquivo de número 5 (A5), por exemplo, há dois atributos **DGC**. Posto que não há singularidade, esse tipo de conflito impossibilita a manutenção da desiginação original, consequentemente, a importação dos dados feita com *data loaders* (eg.: 'read_xlsx') dos principais pacotes estatísticos automaticamente altera o identificador para **DGC** e **DGC_1**.

A tabela de frequência do Apêndice A apresenta todos os atributos conflitantes, já a Tabela 1 exibe os 11 indicadores selecionados na seção IV (p. 28). Note que uma BD consistente exibiria frequência 1 em cada arquivo e um total de 5, as siglas **A1**-**A5** referem-se aos arquivos.


```{r, echo = F, warning = FALSE, message = F}
library(data.table); library(dplyr); library(pander)

  # File and sheet location

  sheet <- "Base Dados"
  folder_path <- "./data/"
  
  # Get file path for all documents in the folder
  path_files <- list.files(folder_path, full.names = T, pattern = ".xlsx") 
  
  # Read all files
  
  file_dump <- lapply(path_files, function(x) readxl::read_xlsx(path = x, sheet = sheet, skip = 5, col_names = F )) # Note takes header as first observation
  
  header <- NULL
  
  for(i in 1:length(path_files)){
      header[[i]] <- data.frame(col = t(file_dump[[i]][1,]), file = path_files[i])
  }
  
  # Binds every file in folder path 
  header <- data.table::rbindlist(header); 

  # Keeps table good-looking
  tab <- addmargins(table(header$col, header$file), 2); rm (header)
  colnames(tab) <-c("A1", "A2", "A3", "A4", "A5", "Total")
  rownames(tab)[which(rownames(tab) == "Sum")] <- "Total"
  
```



```{r, echo = F, warning = F}
header = c("DLR / EBITDA Ajst - QRR",
           "EBITDA Ajst / VPB Reg", 
           "PMSO Ajustado / PMSO Regulatório", 
           "Capex U4/5A", 
           "QRR U4/5A", 
           "EBIT Ajst - EBIT Reg / BRL",
           "Setoriais Constituição / EBITDA Reg",
           "Fluxo Acionista / (BRL x Cap Próprio)",
           "DGC", 
           "Perdas Realizadas",
           "Perdas Regulatórias",
           "Mercado CAGR U5A",
           "Nº CAGR U5A")


tab2 <- tab[match( header, rownames(tab)), ]
pander(tab2, caption = "Tabela 1: **A1**:Indicadores Base 2017 1T 2017 08 07.xlsx, **A2**: Indicadores Base 2017 2T 2017 11 10.xlsx, **A3**: Indicadores Base 2017 3T 2018 02 20.xlsx, **A4**: Indicadores Base 2018 1T 2018 08 06.xlsx e **A5**: Indicadores Base 2018 1T 2018 08 06.xlsx.")
```

### Tipos de Dado

O tipo de variável é um conceito primordial para aplicação correta de técnicas estatíticas. Há dois tipos de dado o quantitativo ou numérico que resulta de uma mensuração (e.g.: estatura, peso) e o dado qualitativo ou categórico que registra qualidades descritivas ou subjetivas, podem representar grupos ou características (e.g.: sexo) e podem assumir valores numéricos (e.g.: 1 para mulheres e 0 para homens), observe que uma varivel categórica não têm significado matemático.

![Figura 2: Tipos de dado](img/diag.png)

Os indicadores selecionados são provenientes da combinação de atributos de natureza numérica. No entanto, variáveis qualitativas foram consideradas em campos de natureza quantitativa com objetivo de sinalizar situações adversas inerentes ao cálculo desses indicadores. Ou seja, além de valores inteiros e reais, encontram-se células com caracteres, o que configura outra inconsistência na BD. No Apêndice B segue a interpretação para cada valor usado, segundo o Glossário (p. 27) da 5ª Edição do Relatório.

```{r, echo = F, warnings = F, message = F, include = F }
source("read_aneel3.R"); library(pander); library(dplyr)
  
dat <- read_aneel3(folder_path = folder_path, sheet = sheet, col_names = header, clean_names = F )

#  DLR / EBITDA Ajst - QRR  

dat %>% 
  select(`DLR / EBITDA Ajst - QRR`) %>% 
  filter(`DLR / EBITDA Ajst - QRR` == "Cxa Líq" | 
         `DLR / EBITDA Ajst - QRR` == "Flx Neg" | 
         `DLR / EBITDA Ajst - QRR` == "Ebitda Neg" | 
         `DLR / EBITDA Ajst - QRR` == "nd") %>% 
  table() %>% 
  pander()

# Setoriais Constituição / EBITDA Reg

dat %>% 
  select(`Setoriais Constituição / EBITDA Reg`) %>% 
  filter(`Setoriais Constituição / EBITDA Reg` == "nd") %>% 
  table() %>% 
  pander()

# Fluxo Acionista / (BRL x Cap Próprio)

dat %>% 
  select(`Fluxo Acionista / (BRL x Cap Próprio)`) %>% 
  filter(`Fluxo Acionista / (BRL x Cap Próprio)` == "0 / +" |
         `Fluxo Acionista / (BRL x Cap Próprio)` == "- / +") %>% 
  table() %>% 
  pander()

# DGC

dat %>% 
  select(`DGC`) %>% 
  filter(`DGC` == "nd") %>% 
  table() %>%
  pander()

# Perdas Realizadas 

dat %>% 
  select(`Perdas Realizadas`) %>% 
  filter(`Perdas Realizadas` == "nd") %>% 
  table() %>%  
  pander()

# Perdas Regulatórias

dat %>% 
  select(`Perdas Regulatórias`) %>% 
  filter(`Perdas Regulatórias` == "nd") %>% 
  table() %>% 
  pander()

# Nº CAGR U5A

dat %>% 
  select(`Nº CAGR U5A`) %>% 
  filter(`Nº CAGR U5A` == "nd") %>% 
  table() %>% 
  pander()
```

<table>
 <caption>Tabela 2:  Presença de dados qualitativos nos campos quantitativos.</caption>
<thead>
<tr>
<th></th>
<th>Cxa Líq</th>
<th>Ebitda Neg</th>
<th>Flx Neg</th>
<th>nd</th>
<th>0 / +</th>
<th>- / +</th>
</tr>
</thead>
<tbody>
<tr>
<td>DLR / EBITDA Ajst - QRR</td>
<td>220</td>
<td>359</td>
<td>264</td>
<td>12</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Setoriais Constituição / EBITDA Reg</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>2093</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Fluxo Acionista / (BRL x Cap Próprio)</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>394</td>
<td>317</td>
</tr>
<tr>
<td>DGC</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>443</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Perdas Realizadas</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>443</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Perdas Regulatórias</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>443</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>Nº CAGR U5A</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>58</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>

<!-- |                                       | Cxa Líq | Ebitda Neg | Flx Neg | nd   | 0 / + | - / + | -->
<!-- |---------------------------------------|---------|------------|---------|------|-------|-------| -->
<!-- | DLR / EBITDA Ajst - QRR               | 220     | 359        | 264     | 12   | -     | -     | -->
<!-- | Setoriais Constituição / EBITDA Reg   | -       | -          | -       | 2093 | -     | -     | -->
<!-- | Fluxo Acionista / (BRL x Cap Próprio) | -       | -          | -       | -    | 394   | 317   | -->
<!-- | DGC                                   | -       | -          | -       | 443  | -     | -     | -->
<!-- | Perdas Realizadas                     | -       | -          | -       | 443  | -     | -     | -->
<!-- | Perdas Regulatórias                   | -       | -          | -       | 443  | -     | -     | -->
<!-- | Nº CAGR U5A                           | -       | -          | -       | 58   | -     | -     | -->

Isto posto, foi feita a verificação do cálculo dos indicadores no intuito de desvendar os valores correspondentes à "Cxa Líq", "Flx Neg", "Ebitda Neg", nd", "0 / +" e "- / +". Surpreendentemente, regressamos ao problema inicial de colunas repetidas, porém, desta vez com relação aos valores que geram os indicadores selecionados, além disso, descobrimos que há atributos de mesmo nome com valores distintos. Por exemplo, no arquivo **A5** as colunas **EBITDA Ajst** e **EBITDA Ajst_1** diferem 576 vezes (Apêndice C), a Tabela 3 mostra alguns desses conflitos. 

```{r, echo = F, warnings = F, message = F}

tab4 <- file_dump[[5]][-1,which(file_dump[[5]][1,]== "EBITDA Ajst")]
colnames(tab4) <- c("EBITDA Ajst", "EBITDA Ajst_1")

tab4 <- tab4 %>% 
  mutate(`EBITDA Ajst` = as.numeric(`EBITDA Ajst`), `EBITDA Ajst_1` = as.numeric(`EBITDA Ajst_1`)) %>% 
  filter(round(`EBITDA Ajst`, 4)!= round(`EBITDA Ajst_1`, 4)) %>% 
  head() 

  pander(tab4, caption = "Tabela 3: Comparação entre atributos de mesmo nome.")
```

### Princípio da Unicidade

Nesta seção foi abordado o princípio da unicidade baseado em chaves primárias de um sitema de BD relacional. Apesar de não haver estruturação ou relações no plano de BD usado esse conceito proporciona a identificacão de cada item armazenado nas tuplas (linhas) de modo singular. O conceito de chaves primárias refere-se ao campo cujos valores podem ser usadas como um índice de referência, logo, uma chave primária não pode ter valor nulo ou repetição. Na BD, esse indicador único é a variável 'Referência' composta pela combinação de 'Distribuição' e 'Período'. Porém, na Tabela 4, a seguir, observamos a violação desse princípio. Note que a referência é a mesma, porém o valor presente na célula **Mercado CAGR U5A** difere.

```{r, echo = F, warnings = F, message = F}
tab5 <- dat %>% 
  filter(`Referência` == "Cemig-D201703") 

pander(tab5[, c(which(colnames(tab5) ==  "Referência"),
                      which(tab5[1,] != tab5[2,]))], caption = "Tabela 4: Violação do princípio de unicidade de cada observação.")
```

### Conclusão

Ao longo do relatório foi possível identificar ao menos três grandes incoerências na BD que podem ser controladas com a implantação de um BD relacional em um Sitema de Gerenciamento de Banco de Dados (SGBD). Bases de dados relacionais consistem, principalmente de três componentes uma coleção de estruturas de dados, conhecidas como relações (tabelas), operadores relacionais e restrições de integridade, definindo o conjunto consistente de estados de base de dados, bem como de alterações desses estados.
O SGBD talvez seja mais útil para fornecer uma visão centralizada de dados que podem ser acessados por vários usuários, de vários locais, de maneira controlada. Os SGBD de dados são o método preferido de armazenamento, recuperação de dados e informações para aplicações multiusuárias. 

## Análise descritiva

Prosseguiremos agora para a análise descritiva da BD.
Numa tentativa de contornar os problemas previamente citados, assumimos algumas 
premissas:

- Os dados mais recentes são mais confiáveis e serão utilizados quando houver 
valores repetidos para uma determinada entrada no BD.
- Quando o valor não estiver disponível (NA) na base mais recente, a última entrada
válida será considerada.
- A primeira coluna com um determinado nome de variável será selecionada.

Foi feito o estudo descritivo dos indicadores **1**, **2.1**, **2.2**, **4.1**, **4.2**, **5**, **6.2**, **6.4** com base em 9 atributos inicialmente consistentes.

- 1.) DLR / EBITDA Ajst - QRR

- 2.1) EBITDA Ajst / VPB Reg

- 2.2) PMSO Ajustado / PMSO Regulatório

- 4.1) EBIT Ajst - EBIT Reg / BRL

- 4.2) Setoriais Constituição / EBITDA Reg

- 5.) Fluxo Acionista / (BRL x Cap Próprio)

- 6.2) Perdas Realizadas

- 6.2) Perdas Regulatórias

- 6.4) Nº CAGR U5A

```{r data-last}
library(dplyr)
library(ggplot2)

dt <- read.csv("data/dados_last_not_na.csv")

dt_sel <- dt %>% 
  select(dlr_ebitda_ajst_qrr, ebitda_ajst_vpb_reg, pmso_ajustado_pmso_regulatorio,
         capex_u4_5a, ebit_ajst_ebit_reg_brl, setoriais_constituicao_ebitda_reg,
         fluxo_acionista_brl_x_cap_proprio, dgc, perdas_realizadas, perdas_regulatorias,
         mercado_cagr_u5a, n_cagr_u5a) %>% 
  mutate(dlr_ebitda_ajst_qrr = as.numeric(replace(dlr_ebitda_ajst_qrr, 
                                                  dlr_ebitda_ajst_qrr 
                                                  %in% c("Ebitda Neg", "Flx Neg", 
                                                         "Cxa Líq"), NA))) %>% 
  mutate(fluxo_acionista_brl_x_cap_proprio = as.numeric(replace(fluxo_acionista_brl_x_cap_proprio,
                                                                fluxo_acionista_brl_x_cap_proprio 
                                                                %in% c("0 / +", "- / +"), NA)))
  
```

A base de dados apresenta as 11 variáveis selecionadas no documento da ANEEL. As
variáveis perdas realizadas e perdas regulatórias presentes no indicador 6.2 são
apresentadas como duas variáveis separadas. As variáveis apresentam um grande número
de valores faltantes, como mostrado na tabela abaixo.

```{r, echo = F}

cnames1 <-  c("Média", "Mediana", "DP","CV")
cnames2 <-  c("1º Q", "3º Q", "DIQ", "NA")

rnames <- c("DLR / EBITDA Ajst - QRR",
            "EBITDA Ajst / VPB Reg",
            "PMSO Ajustado / PMSO Regulatório",
            "EBIT Ajst - EBIT Reg / BRL",
            "Setoriais Constituição / EBITDA Reg",
            "Fluxo Acionista / (BRL x Cap Próprio)",
            "Perdas Realizadas",
            "Perdas Regulatórias",
            "Nº CAGR U5A")

desc1 <- matrix(NA, ncol = length(cnames1), nrow = length(rnames), dimnames = list(rnames, cnames1))
desc2 <- matrix(NA, ncol = length(cnames2), nrow = length(rnames), dimnames = list(rnames, cnames2))

rnames <- dat %>% 
  select(rnames) %>% 
  janitor::clean_names() %>% 
  colnames()
rnames[which(rnames == "nº_cagr_u5a")] <- "n_cagr_u5a"


dt2 <- dt_sel[, match(rnames, colnames(dt_sel))] 

desc1[,1] <- apply(dt2, 2, mean, na.rm = T)
desc1[,2] <- apply(dt2, 2, median, na.rm = T)
desc1[,3] <- apply(dt2, 2, sd, na.rm = T)
desc1[,4] <- desc1[,1] / desc1[,3]

desc2[,1] <- apply(dt2, 2, function(x) quantile(x, na.rm = T)[2])
desc2[,2] <- apply(dt2, 2, function(x) quantile(x, na.rm = T)[4])
desc2[,3] <- desc2[,2] - desc2[,1]
desc2[,4] <- apply(dt2, 2, function(x)sum(is.na(x)))

pander::pander(desc1, digits = 4, caption = "Tabela 5: Média, Mediana, Desvio-Padrão (DP) e Coeficiente de Variação (CV)")
pander::pander(desc2, digits = 4, caption = "Tabela 6: Primeiro quartil (1º Q), Terceiro Quartil (3º Q), Distância Interquartílica (DIQ) e Dados Faltantes (NA).")
```



### Endividamento

```{r endividamento}
ggplot(dt_sel, aes(dlr_ebitda_ajst_qrr)) +
  geom_histogram(bins = 10, na.rm = T, fill = "lightblue", color = "white") +
  labs(x = "Endividamento", y = "Frequência") +
  theme_light()
```

### Eficiência

```{r ef-1}
ggplot(dt_sel, aes(ebitda_ajst_vpb_reg)) +
  geom_histogram(bins = 10, na.rm = T, fill = "lightblue", color = "white") +
  labs(x = "Eficiência (2.1)", y = "Frequência") +
  theme_light()
```

```{r ef-2}
ggplot(dt_sel, aes(pmso_ajustado_pmso_regulatorio)) +
  geom_histogram(bins = 10, na.rm = T, fill = "lightblue", color = "white") +
  labs(x = "Eficiência (2.2)", y = "Frequência") +
  theme_light()
```

### Rentabilidade

```{r rentabilidade}
ggplot(dt_sel, aes(ebit_ajst_ebit_reg_brl)) +
  geom_histogram(bins = 10, na.rm = T, fill = "lightblue", color = "white") +
  labs(x = "Rentabilidade (4.1)", y = "Frequência") +
  theme_light()
```

```{r rentabilidade-2}
ggplot(dt_sel, aes(setoriais_constituicao_ebitda_reg)) +
  geom_histogram(bins = 10, na.rm = T, fill = "lightblue", color = "white") +
  labs(x = "Rentabilidade (4.2)", y = "Frequência") +
  theme_light()
```

### Retorno ao acionista

```{r acionista}
ggplot(dt_sel, aes(fluxo_acionista_brl_x_cap_proprio)) +
  geom_histogram(bins = 10, na.rm = T, fill = "lightblue", color = "white") +
  labs(x = "Retorno ao acionista", y = "Frequência") +
  theme_light()
```

### Operacional

Como dito anteriormente, as variáveis "Desempenho Global de Continuidade" e 
"Mercado CAGR U5A" não foram avaliadas por não apresentarem consistência na
base de dados.

```{r perdas-1}
ggplot(dt_sel, aes(perdas_realizadas)) +
  geom_histogram(bins = 10, na.rm = T, fill = "lightblue", color = "white") +
  labs(x = "Operacional (6.2.1)", y = "Frequência") +
  theme_light()
```

```{r perdas-2}
ggplot(dt_sel, aes(perdas_regulatorias)) +
  geom_histogram(bins = 10, na.rm = T, fill = "lightblue", color = "white") +
  labs(x = "Operacional (6.2.2)", y = "Frequência") +
  theme_light()
```

```{r consumidores}
ggplot(dt_sel, aes(n_cagr_u5a)) +
  geom_histogram(bins = 10, na.rm = T, fill = "lightblue", color = "white") +
  labs(x = "Operacional (6.4)", y = "Frequência") +
  theme_light()
```

### Correlograma

```{r correlogram}
cor_matrix <- cor(dt_sel, use = "complete.obs")
colnames(cor_matrix) <- c("endiv", "efic 2.1", "efic 2.2", "invest", "renta 4.1",
                          "renta 4.2.", "acion", "opera 6.1", "opera 6.2.1",
                          "opera 6.2.2", "opera 6.3", "opera 6.4")
rownames(cor_matrix) <- c("endiv", "efic 2.1", "efic 2.2", "invest", "renta 4.1",
                          "renta 4.2.", "acion", "opera 6.1", "opera 6.2.1",
                          "opera 6.2.2", "opera 6.3", "opera 6.4")

ord <- order(cor_matrix[1,])
xc <- cor_matrix[ord, ord]

ellipse::plotcorr(xc, col=cm.colors(12)[5*xc + 6], type = "lower", diag = TRUE)

```

## Visualização das séries temporais

Séries temporais para a CEMIG-D

```{r cemig}
dt_cemig <- dt %>% 
  select(dlr_ebitda_ajst_qrr, ebitda_ajst_vpb_reg, pmso_ajustado_pmso_regulatorio,
         capex_u4_5a, ebit_ajst_ebit_reg_brl, setoriais_constituicao_ebitda_reg,
         fluxo_acionista_brl_x_cap_proprio, dgc, perdas_realizadas, perdas_regulatorias,
         mercado_cagr_u5a, n_cagr_u5a, distribuidora_r_mil, periodo) %>% 
  mutate(dlr_ebitda_ajst_qrr = as.numeric(replace(dlr_ebitda_ajst_qrr, 
                                                  dlr_ebitda_ajst_qrr 
                                                  %in% c("Ebitda Neg", "Flx Neg", 
                                                         "Cxa Líq"), NA))) %>% 
  mutate(fluxo_acionista_brl_x_cap_proprio = as.numeric(replace(fluxo_acionista_brl_x_cap_proprio,
                                                                fluxo_acionista_brl_x_cap_proprio 
                                                                %in% c("0 / +", "- / +"), NA))) %>% 
  filter(distribuidora_r_mil == "Cemig-D") %>% 
  select(-distribuidora_r_mil)
  
```

```{r fix-date}
library(zoo)

yr <- substr(as.character(dt_cemig$periodo), 1, 4)
mth <- substr(as.character(dt_cemig$periodo), 5, 6)
dt_cemig$date <- as.yearmon(paste0(yr, "-", mth))
```

### Endividamento

```{r endividamento-t}
t_series <- zoo(dt_cemig$dlr_ebitda_ajst_qrr, dt_cemig$date)
t_na <- na.approx(t_series)
dt_cemig$series <- as.numeric(t_na)

ggplot(dt_cemig, aes(x = date, y = dlr_ebitda_ajst_qrr)) + 
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  geom_path(aes(y = series), linetype = "dashed", color = "darkblue") + 
  labs(x = "Data",y = "Endividamento") +
  theme_light()
```

### Eficiência

```{r ef-1-t}
t_series <- zoo(dt_cemig$ebitda_ajst_vpb_reg, dt_cemig$date)
t_na <- na.approx(t_series)
dt_cemig$series <- as.numeric(t_na)

ggplot(dt_cemig, aes(x = date, y = ebitda_ajst_vpb_reg)) + 
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  geom_path(aes(y = series), linetype = "dashed", color = "darkblue") + 
  labs(x = "Data", y = "Eficiência (2.1)") +
  theme_light()
```

```{r ef-2-t}
t_series <- zoo(dt_cemig$pmso_ajustado_pmso_regulatorio, dt_cemig$date)
t_na <- na.approx(t_series)
dt_cemig$series <- as.numeric(t_na)

ggplot(dt_cemig, aes(x = date, y = pmso_ajustado_pmso_regulatorio)) + 
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  geom_path(aes(y = series), linetype = "dashed", color = "darkblue") + 
  labs(x = "Data", y = "Eficiência (2.2)") +
  theme_light()
```

### Rentabilidade

```{r rentabilidade-t}
t_series <- zoo(dt_cemig$ebit_ajst_ebit_reg_brl, dt_cemig$date)
t_na <- na.approx(t_series)
dt_cemig$series <- as.numeric(t_na)

ggplot(dt_cemig, aes(x = date, y = ebit_ajst_ebit_reg_brl)) + 
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  geom_path(aes(y = series), linetype = "dashed", color = "darkblue") + 
  labs(x = "Data", y = "Rentabilidade (4.1)") +
  theme_light()
```

```{r rentabilidade-2-t}
t_series <- zoo(dt_cemig$setoriais_constituicao_ebitda_reg, dt_cemig$date)
t_na <- na.approx(t_series)
dt_cemig$series <- as.numeric(t_na)

ggplot(dt_cemig, aes(x = date, y = setoriais_constituicao_ebitda_reg)) + 
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  geom_path(aes(y = series), linetype = "dashed", color = "darkblue") + 
  labs(x = "Data", y = "Rentabilidade (4.2)") +
  theme_light()
```

### Retorno ao acionista

```{r acionista-t}
t_series <- zoo(dt_cemig$fluxo_acionista_brl_x_cap_proprio, dt_cemig$date)
t_na <- na.approx(t_series)
dt_cemig$series <- c(as.numeric(t_na), rep(240, 7))

ggplot(dt_cemig, aes(x = date, y = fluxo_acionista_brl_x_cap_proprio)) + 
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  geom_path(aes(y = series), linetype = "dashed", color = "darkblue") + 
  labs(x = "Data", y = "Retorno ao acionista") +
  theme_light()
```

### Operacional

```{r perdas-1-t}
t_series <- zoo(dt_cemig$perdas_realizadas, dt_cemig$date)
t_na <- na.approx(t_series)
dt_cemig$series <- c(as.numeric(t_na), rep(0.1323, 2))

ggplot(dt_cemig, aes(x = date, y = perdas_realizadas)) + 
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  geom_path(aes(y = series), linetype = "dashed", color = "darkblue") + 
  labs(x = "Data", y = "Operacional (6.2.1)") +
  theme_light()
```

```{r perdas-2-t}
t_series <- zoo(dt_cemig$perdas_regulatorias, dt_cemig$date)
t_na <- na.approx(t_series)
dt_cemig$series <- c(as.numeric(t_na), rep(0.1073, 2))

ggplot(dt_cemig, aes(x = date, y = perdas_regulatorias)) + 
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  geom_path(aes(y = series), linetype = "dashed", color = "darkblue") + 
  labs(x = "Data", y = "Operacional (6.2.2)") +
  theme_light()
```

```{r consumidores-t}
t_series <- zoo(dt_cemig$n_cagr_u5a, dt_cemig$date)
t_na <- na.approx(t_series)
dt_cemig$series <- c(as.numeric(t_na), rep(0.02198, 2))

ggplot(dt_cemig, aes(x = date, y = n_cagr_u5a)) + 
  geom_line(color = "darkblue") +
  geom_point(color = "darkblue") +
  geom_path(aes(y = series), linetype = "dashed", color = "darkblue") + 
  labs(x = "Data", y = "Operacional (6.4)") +
  theme_light()
```

## Apêndice A

```{r, echo = F}
# Ordering by highest frequency
    tab1 <- subset(tab, tab[,6] != 5)
 pander(tab1[order(tab1[,6], decreasing = T),],
                 caption = "**A1**:Indicadores Base 2017 1T 2017 08 07.xlsx, **A2**: Indicadores Base 2017 2T 2017 11 10.xlsx, **A3**: Indicadores Base 2017 3T 2018 02 20.xlsx, **A4**: Indicadores Base 2018 1T 2018 08 06.xlsx e **A5**: Indicadores Base 2018 1T 2018 08 06.xlsx.")
```

## Apêndice B

| Variável              | Dicionário                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|-----------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Ajst                  | Ajustado. O termo “Ajst” aplicado ao PMSO, EBIT e EBITDA se refere ao estorno das Despesas com Programa de Demissão Voluntária, Déficit ou Superávit Atuarial dos Benefícios Pós-Emprego, Provisões Credoras, Provisão para Redução ao Valor Recuperação e Recuperação de Despesas acima de 1% da ROL e que está em consonância com os ajustes previstos para o EBITDA dos contratos de distribuição aditivados a partir de dez/2015.                              |
| BAR                   | Base de Anuidade Regulatória.                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| BRL                   | Base de Remuneração Líquida. Fonte: Laudo de Avaliação                                                                                                                                                                                                                                                                                                                                                                                                             |
| CAIMI                 | Custo Anual das Instalações Móveis e Imóveis (Anuidades).                                                                                                                                                                                                                                                                                                                                                                                                          |
| Capex                 | Investimento realizado pela concessionária em AIS e AIC deduzido de 50% das baixas líquidas e das Obrigações Especiais em AIS e AIC, corrigido pelo IPCA. Fonte: RIT - RP 1232.D                                                                                                                                                                                                                                                                                   |
| Cxa Líq               | Caixa Líquido = ativos financeiros maiores que a dívida bruta. Para índices como [DLR / (EBITDA - QRR)] não faz sentido calculá-lo.                                                                                                                                                                                                                                                                                                                                |
| DEC                   | Duração Equivalente de Interrupção por Unidade Consumidora. Fonte: Site ANEEL                                                                                                                                                                                                                                                                                                                                                                                      |
| DGC                   | Indicador de Desempenho Global de Continuidade. Fonte: Site ANEEL                                                                                                                                                                                                                                                                                                                                                                                                  |
| DLR                   | Dívida Líquida com Ativos e Passivos Financeiros Setoriais.                                                                                                                                                                                                                                                                                                                                                                                                        |
| EBIT                  | Earns Before Interest and Taxes = Resultado das Atividades.                                                                                                                                                                                                                                                                                                                                                                                                        |
| EBIT Ajst             | Ajst: EBIT Ajustado = Resultado das Atividades Ajustado. Para fins de cálculo do indicador 4.1, excluiu-se a Despesa com Aluguéis e Arrendamentos, uma vez que estes gastos relativos à BAR são reembolsados pelo CAIMI.                                                                                                                                                                                                                                           |
| EBIT Reg              | EBIT Regulatório = Resultado da Atividade Regulatório = Remuneração Bruta.Na RTP, há discriminação de Outras Receitas que são abatidas para a modicidade tarifária. Nos RTOs, só há abertura a partir de 2017 para os contratos aditivados. Assim, para os  RTOs que não têm Outras Receitas, calculou-se essas receitas pela variação do IPCA que é agregado ao VPB, que por sua vez é deduzido pelo PMSO e pela QRRC para se obter a Remuneração Regulatória.    |
| EBITDA                | Earns Before Interest, Taxes, Depreciation and Amortization = Geração Operacional Bruta de Caixa. EBIT acrescido das despesas de amortização e de depreciação.                                                                                                                                                                                                                                                                                                     |
| EBITDA Ajst           | EBIT Ajst acrescido das despesas de amortização e de depreciação.                                                                                                                                                                                                                                                                                                                                                                                                  |
| EBITDA Reg            | EBITDA Regulatório.                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| FEC                   | Frequência Equivalente de Interrupção por Unidade Consumidora. Fonte: Site ANEEL                                                                                                                                                                                                                                                                                                                                                                                   |
| Fluxo do Acionista    | Somatório de dividendos, juros sobre o capital próprio (JCP), aportes de capital, adiantamentos para futuro aumento de capital com entrada efetiva de recursos, emissão de ações, redução de capital e conversão de mútuos passivos.                                                                                                                                                                                                                               |
| Flx Neg               | Resultado menor que zero do EBITDA deduzido da QRR => QRR > EBITDA.                                                                                                                                                                                                                                                                                                                                                                                                |
| IRT                   | Índice de Reajuste Tarifário.                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Mercado GWh CAGR U5A  | Taxa composta de crescimento anual (Compound Annual Growth Rate) do mercado livre e cativo em GWh faturados nos últimos 5 anos. Fonte: SAMP                                                                                                                                                                                                                                                                                                                        |
| Nº Consumid. CAGR U5A | Taxa composta de crescimento anual (Compound Annual Growth Rate) do número total de consumidores nos últimos 5 anos. Fonte: SAMP                                                                                                                                                                                                                                                                                                                                   |
| Perdas Realizadas     | Perdas da energia injetada. Fonte: Samp                                                                                                                                                                                                                                                                                                                                                                                                                            |
| Perdas Regulatórias   | Perdas regulatórias de energia injetada. Obtenção por meio do cálculo pro rata mês das revisões/reajustes anteriores. Fonte: IRT                                                                                                                                                                                                                                                                                                                                   |
| PMSO                  | Somatório das Despesas de Pessoal, Materiais, Serviços de Terceiros e Outros (inclui Amortização e Depreciação).                                                                                                                                                                                                                                                                                                                                                   |
| PMSO Cxa              | Somatório das Despesas de Pessoal, Materiais, Serviços de Terceiros e Outros de Efeito Caixa (exclui Amortização e Depreciação).                                                                                                                                                                                                                                                                                                                                   |
| PMSO Cxa Ajst         | Somatório das Despesas de Pessoal, Materiais, Serviços de Terceiros e Outros de Efeito Caixa (exclui Amortização e Depreciação) Ajustado. Para fins de cálculo do indicador 2.2, excluiu-se a Despesa com Aluguéis e Arrendamentos, uma vez que estes gastos relativos à BAR são remunerados pelo CAIMI e as despesas de geração.                                                                                                                                  |
| PMSO Reg              | PMSO Cxa Regulatório (CAOM e Ajustes da Parcela B). Nos interstícios entre revisões terá alteração conforme a variação % entre o VPB1 DRP Ano 1 e o VPB1 DRP Ano 0, ambos sem Outras Receitas.                                                                                                                                                                                                                                                                     |
| QRR                   | Quota de Reintegração Regulatória. Nos interstícios entre revisões terá alteração conforme a variação % entre o VPB1 DRP Ano 1 e o VPB1 DRP Ano 0, ambos sem Outras Receitas.                                                                                                                                                                                                                                                                                      |
| QRRC                  | Quota de Reintegração Regulatória acrescida de 66,44% do Caimi, relativa à parte de depreciação da BAR. Nos interstícios entre revisões terá alteração conforme a variação% entre o VPB1 DRP Ano 1 e o VPB1 DRP Ano 0, ambos sem Outras Receitas.                                                                                                                                                                                                                  |
| Rec Bruta             | Somatório das receitas brutas da atividade operacional = (-) 61X1 (-) 61X1.X.30/1.                                                                                                                                                                                                                                                                                                                                                                                 |
| Res Fin Pos           | Resultado Financeiro positivo = receitas financeiras superam as despesas financeiras. Para o índice Res. Fin. / EBITDA não faz sentido calculá-lo.                                                                                                                                                                                                                                                                                                                 |
| ROL                   | Somatório das receitas brutas da atividade operacional deduzido dos tributos indiretos = (-) 61X1 (-) 61X1.X.31.                                                                                                                                                                                                                                                                                                                                                   |
| RTO                   | Reajuste Tarifário Ordinário.                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| RTP                   | Revisão Tarifária Periódica.                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Selic                 | Taxa média anual ponderada e ajustada das operações de financiamento lastreadas em títulos públicos federais, calculada diariamente e apresentada no sítio do Banco Centraldo Brasil - http://www.bcb.gov.br/?SELICACUMUL. Para fins específicos deste projeto e em consonância com os novos contratos de distribuição, a Selic deverá ser limitada ao valor de  12,87% (doze inteiros e oitenta e sete centésimos por cento) ao ano, caso supere esse percentual. |
| U4A                   | Últimos 4 (quatro) anos.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| U5A                   | Útimos 5 (cinco) anos.                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| UDM                   | Últimos 12 (doze) meses.                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| VPA                   | Custos da Parcela A = Custos setoriais = Encargos do Consumidor, Despesas com Compra de Energia, Transmissão e Combustível para Geração (líquido do Reembolso da CCC).                                                                                                                                                                                                                                                                                             |
| VPB                   | Parcela B = ROL deduzida dos Custos da Parcela A (VPA).                                                                                                                                                                                                                                                                                                                                                                                                            |
| VPB Reg               | Parcela B Regulatória = Itens calculados pela ANEEL e contemplados na tarifa de Despesas de PMSO e Depreciação e Remuneração dos investimentos realizados prudentemente. Observa-se que nos RTOs, só há abertura de Outras Receitas a partir de 2017 para os contratos aditivados. Assim, para os RTOs que não as têm, calculou-se essas receitas pela variação do IPCA que é agregado ao VPB das tarifas para se chegar ao VPB Reg.                               |

## Apêndice C

```{r, echo = F}
tab4 %>% 
  mutate(`EBITDA Ajst` = as.numeric(`EBITDA Ajst`), `EBITDA Ajst_1` = as.numeric(`EBITDA Ajst_1`)) %>% 
  filter(round(`EBITDA Ajst`, 4)!= round(`EBITDA Ajst_1`, 4)) %>% 
  pander()
```
